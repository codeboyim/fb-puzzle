<!DOCTYPE html>
<html>

<head>
    <title>Hello React</title>

    <script src="/scripts/console-polyfill.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/es5-shim/2.1.0/es5-shim.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/es5-shim/2.1.0/es5-sham.min.js"></script>
    <!-- <script src="http://fb.me/react-0.5.1.js"></script>
    <script src="http://fb.me/JSXTransformer-0.5.1.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/showdown/0.3.1/showdown.min.js"></script>    -->
    <script src="//codeorigin.jquery.com/jquery-1.10.2.js"></script>
    <script src="/quickSort.js"></script>
    <style>
    body {
        color:#797979;
        font-family:'lucida grande', tahoma, verdana, arial, sans-serif;
        font-size:11px
    }
    h1, h2, h3, h4, h5, h6 {
        font-size:13px;
        margin:0;
        padding:0
    }
    p {
        margin:0;
        padding:0;
    }
    .event {
        position:relative;
        vertical-align: top;
        display:inline-block;
        border-left:4px solid #4b6ea9;
        overflow:hidden;
        margin:0;
        padding:0;
        top:0;
        left:0;
        box-sizing: border-box;
        -moz-box-sizing: border-box;
        -webkit-box-sizing: border-box;
    }
    .event .content {
        background-color:white;
        overflow:hidden;
        border:solid 1px #d5d5d5;
        border-left:none;
        padding:6px;
        box-sizing: border-box;
        -moz-box-sizing: border-box;
        -webkit-box-sizing: border-box;
    }
    .event .header {
        color:#3b5998;
        font-size:12px;
    }
    #container {
        width:600px;
        padding: 0 10px;
        height:720px;
        position:relative;
        background-color:#ececec;
    }
    </style>
    <!--[if lt IE 8]>
    <style>
    .event {
        display:inline;
        zoom:1;
    }
    </style>
    <![endif]-->
</head>

<body>

    <div id="container">

    </div>
    <script>
    var isLtIE8 = false;
    </script>
    <!--[if lt IE 8]>
    <script>
    isLtIE8=true;
    </script>
    <![endif]-->

    <script>
    // Array.prototype.sort = function(cmp) {
    //     return quickSort(this, cmp);
    // };

    var events = [{
        start: 80,
        end: 150
    }, {
        start: 260,
        end: 280
    }, {
        start: 80,
        end: 140
    }, {
        start: 210,
        end: 250
    }, {
        start: 210,
        end: 220
    }, {
        start: 165,
        end: 180
    }, {
        start: 160,
        end: 200
    }, {
        start: 180,
        end: 220
    }, {
        start: 175,
        end: 270
    }, {
        start: 240,
        end: 250
    }, {
        start: 180,
        end: 200
    }, {
        start: 350,
        end: 500
    }, {
        start: 400,
        end: 500
    }, {
        start: 550,
        end: 600
    }, {
        start: 580,
        end: 650
    }, {
        start: 590,
        end: 700
    }];


    var SingleDayCal = (function() {

        var eventTemplate = '<div class="event"><div class="content"><h2 class="header">Sample Item</h2><p class="body">Sample Location</p></div></div>',
            minStart = 0,
            maxEnd = 720;


        //sort events by start time and place colliding events' indexes in groups

        function sortEvents(events) {

            var groups = [];

            if (!Array.isArray(events) || !events.length) {
                return groups;
            }

            events.sort(function(e1, e2) {

                return e1.start - e2.start;

            });

            events.forEach(function(event, i) {

                var group,
                    collide = false,
                    collideCount = 0,
                    tmp;

                //validate event
                if (event.start > event.end) {
                    tmp = event.end;
                    event.end = event.start;
                    event.start = tmp;
                }

                if (event.start < minStart) {
                    event.start = minStart;
                }

                if (event.end > maxEnd) {
                    event.end = maxEnd;
                }

                if (i == 0) {
                    //init a group
                    group = {
                        eventIds: [i], //to store all the indexes of colliding events
                        maxCollidingCount: 0 //to store the max colliding count of the group
                    };

                    groups.push(group);

                } else {
                    //find last group
                    group = groups[groups.length - 1];

                    //find if colliding with any events in the group
                    for (j = i - 1; j >= 0; j--) {

                        if (events[i].start <= events[j].end) {
                            if (group.eventIds.indexOf(i) < 0) {
                                group.eventIds.push(i);
                            }
                            collideCount++;
                        }

                    }

                    if (collideCount == 0) {
                        //no collding happens, create a new group
                        group = {
                            eventIds: [i],
                            maxCollidingCount: 0
                        };

                        groups.push(group);

                    } else if (collideCount > group.maxCollidingCount) {
                        group.maxCollidingCount = collideCount;
                    }
                }

            });

            return groups;

        }

        //attach event to dom

        function renderEventElement(event, width, container) {

            var eventElm = $(eventTemplate);

            eventElm.appendTo(container)
                .css({
                    width: !isLtIE8 ? width : (width - 4),
                    marginTop: event.start - eventElm.get(0).offsetTop
                })
                .attr('title', event.start + ' - ' + event.end);

            eventElm.children('.content').css('height', event.end - event.start-(isLtIE8?12:0));

            return eventElm;
        }

        function renderEvents(events, groups, container) {

            var totalWidth = container.width();

            container.before(totalWidth);

            groups = !Array.isArray(groups) ? [] : groups;
            events = !Array.isArray(events) ? [] : events;
            container.html('');

            groups.forEach(function(group, i) {

                var groupEventsLen = group && Array.isArray(group.eventIds) ? group.eventIds.length : 0,
                    eventWidth,
                    columns; //store the latest end value of each column

                if (groupEventsLen > 0) {

                    //all events in the same colliding group will have same width according to 2)
                    eventWidth = Math.round(totalWidth / (group.maxCollidingCount + 1));

                    //collading events in the same group will be placed into different columns
                    columns = new Array(group.maxCollidingCount + 1);

                    group.eventIds.forEach(function(id, j) {

                        var event = events[id],
                            elm = renderEventElement(event, eventWidth, container),
                            colIndex = j % (group.maxCollidingCount + 1);

                        //put event in the corresponding column.
                        //consideration: instead of searching for the most *first fit* column for every event, 
                        //a move into a preceding column will only be considered when it would overlap
                        //the event above in the same column where it's supposed to be.
                        if (typeof(columns[colIndex]) !== 'number' || columns[colIndex] < event.start) {

                            columns[colIndex] = event.end;

                        } else {

                            for (var k = 0; k < colIndex; k++) {

                                if (columns[k] < event.start) {
                                    columns[k] = event.end;
                                    elm.css('left', -(colIndex - k) * eventWidth);
                                    break;
                                }

                            }

                        }

                        //clear the baseline for next group
                        if (j == groupEventsLen - 1) {
                            elm.after('<div></div>')
                        }
                    })
                }
            });

            return container;
        }

        var SingleDayCal = function(events, attachToElm) {
            this._events = events || [];
            this._container = attachToElm || $("#container");
        };

        SingleDayCal.prototype = {
            layOutDay: function() {
                renderEvents(this._events, sortEvents(this._events), this._container);
                return this;
            }
        }

        return SingleDayCal;
    })();

    function layOutDay(events) {

        var cal;

        events = Array.isArray(events) ? events : [];
        cal = new SingleDayCal(events);
        cal.layOutDay();

        return events.length;
    }

    layOutDay(events);
    </script>

    <div id="content"></div>
    <script type="text/jsx">
    // /**
    //  * @jsx React.DOM
    //  */

    // var CommentBox = React.createClass({
    //         render: function() {
    //             return ( < div className = "commentBox" > < h1 > Comments < /h1>
    //         <CommentList data={this.props.data} / > < CommentForm / > < /div>
    //     );
    //   }
    // });

    // var CommentList = React.createClass({
    //   render:function(){
    //     var commentNodes = this.props.data.map(function(comment){
    //       return <Comment author={comment.author}>{comment.text}</Comment >
    //             });
    //         return ( < div className = "commentList" > {
    //             commentNodes
    //         } < /div>
    //     );
    //   }
    // });

    // var CommentForm = React.createClass({
    //   render: function(){
    //     return (
    //       <div className="commentForm">
    //         Hello, world! I am a CommentForm.
    //       </div > );
    //     }
    // });

    // var converter = new Showdown.converter();
    // var Comment = React.createClass({
    //         render: function() {
    //             var rawMarkup = converter.makeHtml(this.props.children.toString());
    //             return ( < div className = "comment" > < h2 className = "commentAuthor" > {
    //                     this.props.author
    //                 } < /h2>
    //         <span dangerouslySetInnerHTML={{__html: rawMarkup}} / > < /div>
    //     );
    //   }
    // });

    // var data = [
    //   {author: "Pete Hunt", text: "This is one comment"},
    //   {author: "Jordan Walke", text: "This is *another* comment"},
    // ];


    // React.renderComponent(
    //   <CommentBox data={data} / > ,
    //                 document.getElementById('content')
    //             );
    </script>
</body>

</html>
